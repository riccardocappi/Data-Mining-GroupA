---
title: "HW_KNN"
author: "Riccardo Cappi"
date: "2024-03-27"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### KNN Homework
```{r}
#TODO:
# - Feature engineering to reduce the feature dimensionality.
# - Perform k-fold cross-validation choosing a k value
# - Perform KNN on training set and on cross-validation set, by increasing K.
```

## Importing required libraries
```{r}
library(caret)
library(ggplot2)
# library(class)
library(FNN)
library(reshape2)
```

## Import dataset
```{r}
validation_data <- read.csv("wineq_validation.csv") 
data = read.csv("wineq_train.csv")
summary(data)
print('')
print('correlation Matrix values:')
corr <- round(cor(data), 2)
corr
print('')
print('correlation matrixheatmap:')
melted_cormat <- melt(corr)
ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile(color = "white")+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
    midpoint = 0, limit = c(-1,1), space = "Lab", 
    name="Correlation") +
   theme_minimal()+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
     size = 12, hjust = 1))+
  coord_fixed()


```

###The most correlated pairs are: 
density : residual.sugar      0.84
density : alcohol          -0.78
free.sulfur.dioxide : total.sulfur.dioxide  0.63
total.sulfur.dioxide : density    0.54
residual.sugar : alcohol       -0.46
total.sulfur.dioxide : alcohol   -0.46
pH : fixed.acidity      -0.41


###features with almost no correlation with quality:
citric.acid      -0.01
free.sulfur.dioxide  0.01
sulphates    0.05
pH      0.10
residual.sugar  -0.10
fixed.acidity   -0.11



## Feture engineering
```{r}
# TODO: feature engineering
transform_data <- function(X){
  
  X <- X[,!(names(X) %in% omitted_features) ]
  #X <- predict(pca, newdata = X)[, 1:9]
  return(X)
}
compute_pca <- function(X){
  X <- X[,!(names(X) %in% omitted_features) ]
pca <- prcomp(X, scale. = TRUE)
print('proportion of variance')
print(summary(pca)$importance[2,])
print('cumulativ variance')
print(summary(pca)$importance[3,])
}
omitted_features <- c("citric.acid")
X <- data[, -12]
y <- data$quality
X <- as.data.frame(scale(X)) #scaling data
pca <- compute_pca(X)
X <- transform_data(X)
summary(X)
X_val <- transform_data(validation_data)
```

## RMSE function
```{r}
RMSE <- function(y_true, y_pred){
  return(sqrt(mean((y_true - y_pred)^2)))
}
```

## KNN function
```{r}
fit_knn <- function(X_train, y_train, X_test, k_val){
  y_hat = knn.reg(train = X_train, test=X_test, y=y_train, k = k_val)
  y_hat = y_hat$pred
  return(y_hat)
}
```





## Fit KNN on training set
```{r}
k_range = seq(1, 50, by = 1)
train_rmse <- c()
for (k in k_range){
  y_hat = fit_knn(X, y, X, k)
  train_rmse <- append(train_rmse, RMSE(y, y_hat))
}
train_rmse
```


## k-fold cross validation
```{r}
k_fold_cv <- function(X, y){
  set.seed(42)
  folds <- createFolds(y, k = 5, list = TRUE)
  cv_rmse <- c()
  
  for (k in k_range){
    cv_rmse_fold <- c()
    for (i in 1:length(folds)) {
      #unlist function flatten the list. Remember that folds is a list of lists
      train_indexes <- unlist(folds[-i]) 
      test_indexes <- unlist(folds[i])
      
      X_train <- X[train_indexes, ]
      y_train <- y[train_indexes]
      X_test <- X[test_indexes, ]
      y_test <- y[test_indexes]
      
      y_hat <- fit_knn(X_train, y_train, X_test, k)
      cv_rmse_fold <- append(cv_rmse_fold, RMSE(y_test, y_hat))
    }
    cv_rmse <- append(cv_rmse, mean(cv_rmse_fold))
  }
  results <- data.frame(k = k_range, train_rmse = train_rmse, cv_rmse = cv_rmse)
  return(results)
  
}
# The results of k-fold cv are returned as a dataframe.
results <- k_fold_cv(X, y)
str(results)
```



## Plots
```{r}
ggplot(results, aes(x = log(1/k), y = train_rmse, color = "Train RMSE")) +
  geom_line() +
  geom_point() +
  geom_line(aes(x = log(1/k), y = cv_rmse, color = "CV RMSE")) +
  geom_point(aes(x = log(1/k), y = cv_rmse, color = "CV RMSE")) +
  scale_x_continuous(labels = scales::scientific_format()) +
  labs(x = "log (1/K) (K of KNN)", y = "RMSE", color = "Data") +
  theme_minimal()

```
## Best k
```{r}
cv_rmse = results$cv_rmse
minimum <- min(cv_rmse)
print(paste('min cv_rmse:',minimum))
print(paste('          k:', match( minimum , cv_rmse)+1))

```


## TODO: test the model with the lowest cv error

### Just scaled data with no change
[1] "min cv_rmse: 0.706715970421997"
[1] "          k: 12"

### scaled, without citric acid 
[1] "min cv_rmse: 0.703730059806565"
[1] "          k: 15"

### scaled, without citric.acid and free.sulfur.dioxide
[1] "min cv_rmse: 0.720682765728945"
[1] "          k: 11"

### scaled, without density 
[1] "min cv_rmse: 0.708451354386089"
[1] "          k: 8"

### scaled, without residual.sugar
[1] "min cv_rmse: 0.705753479671869"
[1] "          k: 17"

### scaled, without citric acid, PCA with first 9 of 10 components (Best)
[1] "min cv_rmse: 0.703534208790268"
[1] "          k: 15"